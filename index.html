<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Suara JKN - Form Keluhan</title>
<style>
/* ... styling sama kayak versi lo (dipertahankan) ... */
</style>
</head>
<body>
<!-- ... header, form, preview, footer sama persis kayak punya lo ... -->

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const form=document.getElementById('keluhanForm');
const responseMessage=document.getElementById('responseMessage');
const submitBtn=document.getElementById('submitBtn');
const previewBox=document.getElementById('preview');
const ticketNumber=document.getElementById('ticketNumber');

// Ganti pakai kredensial lo sendiri dari Supabase
const SUPABASE_URL = "https://gvfidfyrzrjxxmsdgxmw.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd2ZmlkZnlyenJqeHhtc2RneG13Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxNjg4MDcsImV4cCI6MjA3Mzc0NDgwN30.oCb9nThuh5X_J3Ds8HL-rOIQ_siq_whqjDTjA3eJhos";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

form.addEventListener('submit', async e=>{
  e.preventDefault();

  const data={
    nama:form.nama.value.trim(),
    nohp:form.nohp.value.trim(),
    jenisKelamin:form.jenisKelamin.value,
    lokasiPuskesmas:form.lokasiPuskesmas.value.trim(),
    tujuanKeluhan:form.tujuanKeluhan.value,
    keluhan:form.keluhan.value.trim(),
    klasifikasi:form.klasifikasi.value,
    klasifikasiLainnya:form.klasifikasiLainnya.value.trim()
  };

  // validasi (tetep sama kayak versi lo)
  if(!data.nama || data.nama.length<3){return showError("Nama minimal 3 huruf!");}
  if(!/^[0-9]{10,13}$/.test(data.nohp)){return showError("No HP harus 10-13 digit!");}
  if(!data.jenisKelamin){return showError("Pilih jenis kelamin!");}
  if(!data.lokasiPuskesmas){return showError("Lokasi wajib diisi!");}
  if(!data.tujuanKeluhan){return showError("Pilih tujuan keluhan!");}
  if(!data.klasifikasi){return showError("Pilih klasifikasi!");}
  if(!data.keluhan){return showError("Keluhan wajib diisi!");}

  const ticket="SJKN-"+Date.now();
  ticketNumber.textContent="Nomor Tiket: "+ticket;

  // tampilkan preview (sama kayak versi lo)
  document.getElementById('previewNama').textContent=data.nama;
  document.getElementById('previewNoHP').textContent=data.nohp;
  document.getElementById('previewJK').textContent=data.jenisKelamin;
  document.getElementById('previewPuskesmas').textContent=data.lokasiPuskesmas;
  document.getElementById('previewTujuan').textContent=data.tujuanKeluhan;
  document.getElementById('previewKeluhan').textContent=data.keluhan;
  document.getElementById('previewKlasifikasi').textContent=data.klasifikasi;
  document.getElementById('previewKlasifikasiLainnya').textContent=data.klasifikasiLainnya;

  const fileInput=form.bukti.files[0];
  let buktiUrl = null;

  responseMessage.textContent='Mengirim keluhan...';
  responseMessage.style.color='blue';
  submitBtn.disabled=true;

  try {
    // upload file ke bucket
    if(fileInput){
      const filePath = `${ticket}/${fileInput.name}`;
      const { data: uploadData, error: uploadError } = await supabase.storage
        .from("bukti_keluhan")
        .upload(filePath, fileInput);

      if(uploadError) throw uploadError;

      // ambil public URL
      const { data: publicUrlData } = supabase.storage
        .from("bukti_keluhan")
        .getPublicUrl(filePath);
      buktiUrl = publicUrlData.publicUrl;
    }

    // simpan ke tabel keluhan
    const { error: insertError } = await supabase
      .from("keluhan")
      .insert([{ ...data, ticket, bukti: buktiUrl }]);

    if(insertError) throw insertError;

    alert('Terimakasih, keluhan anda sudah tersimpan. Nomor tiket: '+ticket);
    responseMessage.textContent='Keluhan berhasil dikirim. Nomor tiket: '+ticket;
    responseMessage.style.color='green';
    form.reset();
    previewBox.style.display='block';
  } catch (err) {
    showError("Error: "+err.message);
  } finally {
    submitBtn.disabled=false;
  }
});

function showError(msg){
  responseMessage.textContent=msg;
  responseMessage.style.color="red";
}
</script>
</body>
</html>
